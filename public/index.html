<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Everlasting Vault</title>
  <meta name="description" content="A secure, real-time private chat room." />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root {
      --bg-primary: #0b0f19;
      --bg-secondary: #111827;
      --bg-card: #1a2233;
      --bg-input: #1e293b;
      --accent: #6366f1;
      --accent-hover: #818cf8;
      --text-primary: #f1f5f9;
      --text-muted: #94a3b8;
      --border: #1e293b;
      --success: #22c55e;
      --danger: #ef4444;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      overflow: hidden;
      height: 100vh;
      height: 100dvh;
      /* Fix for mobile address bars */
    }

    /* â”€â”€ Gatekeeper Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #gate-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      height: 100dvh;
      background: radial-gradient(ellipse at 50% 30%, #1e1b4b 0%, #0b0f19 70%);
    }

    /* ... */

    /* â”€â”€ Chat Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #chat-screen {
      display: none;
      flex-direction: column;
      height: 100vh;
      height: 100dvh;
      /* Fix for mobile address bars */
    }

    /* ... */

    /* Input bar */
    .chat-input-bar {
      display: flex;
      align-items: center;
      gap: .6rem;
      padding: .75rem 1rem;
      padding-bottom: max(.75rem, env(safe-area-inset-bottom));
      /* iPhone fix */
      background: var(--bg-secondary);
      border-top: 1px solid var(--border);
      flex-shrink: 0;
    }

    #msg-input {
      flex: 1;
      padding: .75rem 1rem;
      border-radius: 1.5rem;
      border: 1px solid var(--border);
      background: var(--bg-input);
      color: var(--text-primary);
      font-size: .92rem;
      outline: none;
      transition: border-color .2s;
      font-family: inherit;
    }

    #msg-input:focus {
      border-color: var(--accent);
    }

    #msg-input::placeholder {
      color: #475569;
    }

    .send-btn {
      width: 44px;
      height: 44px;
      border: none;
      border-radius: 50%;
      background: linear-gradient(135deg, #6366f1, #7c3aed);
      color: #fff;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform .15s, box-shadow .2s;
      flex-shrink: 0;
    }

    .send-btn:hover {
      transform: scale(1.08);
      box-shadow: 0 4px 16px rgba(99, 102, 241, .4);
    }

    .send-btn:active {
      transform: scale(.95);
    }

    .send-btn:disabled {
      opacity: .4;
      cursor: not-allowed;
      transform: none;
    }

    /* Connection banner */
    .conn-banner {
      display: none;
      text-align: center;
      font-size: .8rem;
      padding: .4rem;
      font-weight: 500;
      flex-shrink: 0;
    }

    .conn-banner.disconnected {
      display: block;
      background: var(--danger);
      color: #fff;
    }

    .conn-banner.reconnecting {
      display: block;
      background: #f59e0b;
      color: #000;
    }

    /* User sidebar (mobile-hidden) */
    .user-sidebar {
      display: none;
      position: fixed;
      top: 0;
      right: 0;
      width: 260px;
      height: 100vh;
      background: var(--bg-secondary);
      border-left: 1px solid var(--border);
      z-index: 100;
      padding: 1.25rem;
      overflow-y: auto;
      animation: slideIn .25s ease-out;
    }

    .user-sidebar.open {
      display: block;
    }

    .sidebar-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .5);
      z-index: 99;
    }

    .sidebar-overlay.open {
      display: block;
    }

    .sidebar-title {
      font-weight: 700;
      font-size: .95rem;
      margin-bottom: 1rem;
    }

    .sidebar-user {
      display: flex;
      align-items: center;
      gap: .5rem;
      padding: .5rem 0;
      font-size: .88rem;
    }

    .sidebar-user-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    /* â”€â”€ Animations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(24px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: .4;
      }
    }

    @keyframes bounce {
      to {
        transform: translateY(-5px);
      }
    }

    @keyframes slideIn {
      from {
        transform: translateX(260px);
      }

      to {
        transform: translateX(0);
      }
    }

    /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 640px) {
      .gate-card {
        padding: 2rem 1.5rem;
      }

      .msg-bubble {
        max-width: 88%;
      }

      .chat-header {
        padding: .65rem .85rem;
      }
    }
  </style>
</head>

<body>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!--  GATEKEEPER SCREEN                              -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="gate-screen">
    <div class="gate-card">
      <div style="font-size:2.5rem;margin-bottom:.5rem;">ğŸ”</div>
      <h1>The Everlasting Vault</h1>
      <p>Enter the access code to unlock the chat.</p>
      <input type="password" id="gate-code" class="gate-input" placeholder="Access code" autocomplete="off" />
      <input type="text" id="gate-username" class="gate-input" placeholder="Your display name" autocomplete="off"
        style="display:none;" />
      <button id="gate-btn" class="gate-btn">Unlock</button>
      <div id="gate-error" class="gate-error"></div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!--  CHAT SCREEN                                    -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="chat-screen">
    <!-- Connection Banner -->
    <div id="conn-banner" class="conn-banner"></div>

    <!-- Header -->
    <div class="chat-header">
      <div class="chat-header-left">
        <div class="vault-icon">ğŸ›ï¸</div>
        <div>
          <div class="header-title">The Everlasting Vault</div>
          <div class="header-subtitle" id="header-subtitle">Encrypted â€¢ Persistent</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:.75rem;">
        <div class="online-badge">
          <span class="online-dot"></span>
          <span id="online-count">0 online</span>
        </div>
        <button id="users-btn"
          style="background:none;border:none;color:var(--text-muted);font-size:1.3rem;cursor:pointer;"
          title="Online users">â˜°</button>
      </div>
    </div>

    <!-- Messages -->
    <div class="chat-messages" id="messages"></div>

    <!-- Typing indicator -->
    <div class="typing-indicator" id="typing-indicator"></div>

    <!-- Input Bar -->
    <form class="chat-input-bar" id="msg-form">
      <input type="text" id="msg-input" placeholder="Type a message..." autocomplete="off" maxlength="2000" />
      <button class="send-btn" id="send-btn" title="Send" type="submit">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
          stroke-linejoin="round" viewBox="0 0 24 24">
          <path d="M22 2 11 13" />
          <path d="M22 2 15 22 11 13 2 9z" />
        </svg>
      </button>
    </form>
  </div>

  <!-- User Sidebar -->
  <div class="sidebar-overlay" id="sidebar-overlay"></div>
  <div class="user-sidebar" id="user-sidebar">
    <div class="sidebar-title">ğŸŸ¢ Online Users</div>
    <div id="user-list"></div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!--  SCRIPT                                         -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <script>
    (() => {
      'use strict';

      // â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const gateScreen = document.getElementById('gate-screen');
      const chatScreen = document.getElementById('chat-screen');
      const gateCode = document.getElementById('gate-code');
      const gateUsername = document.getElementById('gate-username');
      const gateBtn = document.getElementById('gate-btn');
      const gateError = document.getElementById('gate-error');
      const messagesEl = document.getElementById('messages');
      const msgInput = document.getElementById('msg-input');
      const sendBtn = document.getElementById('send-btn');
      const typingEl = document.getElementById('typing-indicator');
      const connBanner = document.getElementById('conn-banner');
      const onlineCount = document.getElementById('online-count');
      const usersBtn = document.getElementById('users-btn');
      const userSidebar = document.getElementById('user-sidebar');
      const sidebarOverlay = document.getElementById('sidebar-overlay');
      const userListEl = document.getElementById('user-list');

      let socket = null;
      let myColor = '#6366f1';
      let myName = '';

      // â”€â”€ Gatekeeper Logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const STORAGE_KEY_AUTH = 'vault_auth';
      const STORAGE_KEY_NAME = 'vault_name';

      // Check sessionStorage for previous auth
      if (sessionStorage.getItem(STORAGE_KEY_AUTH) === 'true' && sessionStorage.getItem(STORAGE_KEY_NAME)) {
        myName = sessionStorage.getItem(STORAGE_KEY_NAME);
        unlockChat();
      }

      // Step 1: validate code â†’ show username field
      // Step 2: choose name â†’ enter chat
      let codeValidated = false;

      gateBtn.addEventListener('click', handleGate);
      gateCode.addEventListener('keydown', e => { if (e.key === 'Enter') handleGate(); });
      gateUsername.addEventListener('keydown', e => { if (e.key === 'Enter') handleGate(); });

      async function handleGate() {
        gateError.textContent = '';

        if (!codeValidated) {
          // Validate code
          const code = gateCode.value.trim();
          if (!code) { gateError.textContent = 'Please enter the access code.'; return; }

          gateBtn.disabled = true;
          gateBtn.textContent = 'Verifying...';
          try {
            const res = await fetch('/api/validate', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ code }),
            });
            const data = await res.json();
            if (data.success) {
              codeValidated = true;
              gateCode.style.display = 'none';
              gateUsername.style.display = 'block';
              gateUsername.focus();
              gateBtn.textContent = 'Enter the Vault';
              document.querySelector('.gate-card p').textContent = 'Choose your display name.';
            } else {
              gateError.textContent = 'ğŸ”’ Invalid access code.';
            }
          } catch {
            gateError.textContent = 'Connection error. Try again.';
          }
          gateBtn.disabled = false;
        } else {
          // Set username
          const name = gateUsername.value.trim();
          if (!name) { gateError.textContent = 'Please enter a display name.'; return; }
          if (name.length > 24) { gateError.textContent = 'Name is too long (max 24 chars).'; return; }
          myName = name;
          sessionStorage.setItem(STORAGE_KEY_AUTH, 'true');
          sessionStorage.setItem(STORAGE_KEY_NAME, myName);
          unlockChat();
        }
      }

      // â”€â”€ Unlock Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function unlockChat() {
        gateScreen.style.display = 'none';
        chatScreen.style.display = 'flex';
        initSocket();
      }

      // â”€â”€ Socket.io â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function initSocket() {
        socket = io({
          reconnection: true,
          reconnectionAttempts: Infinity,
          reconnectionDelay: 1000,
          reconnectionDelayMax: 5000,
          timeout: 20000,
        });

        socket.on('connect', () => {
          connBanner.className = 'conn-banner';
          connBanner.textContent = '';
          socket.emit('user:join', myName);
        });

        socket.on('user:color', (color) => {
          myColor = color;
        });

        socket.on('chat:history', (history) => {
          messagesEl.innerHTML = '';
          history.forEach(m => renderMessage(m));
          scrollToBottom(true);
        });

        socket.on('chat:message', (msg) => {
          renderMessage(msg);
          scrollToBottom();
        });

        socket.on('chat:system', (text) => {
          const div = document.createElement('div');
          div.className = 'msg-system';
          div.textContent = text;
          messagesEl.appendChild(div);
          scrollToBottom();
        });

        socket.on('user:list', (users) => {
          onlineCount.textContent = `${users.length} online`;
          renderUserList(users);
        });

        socket.on('user:typing', ({ username, isTyping }) => {
          if (isTyping) {
            typingEl.innerHTML = `${esc(username)} is typing<span class="typing-dots"><span></span><span></span><span></span></span>`;
          } else {
            typingEl.innerHTML = '';
          }
        });

        // â”€â”€ Reconnection events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        socket.on('disconnect', () => {
          connBanner.className = 'conn-banner disconnected';
          connBanner.textContent = 'âš¡ Disconnected â€” attempting to reconnect...';
        });
        socket.on('reconnect_attempt', () => {
          connBanner.className = 'conn-banner reconnecting';
          connBanner.textContent = 'ğŸ”„ Reconnecting...';
        });
        socket.on('reconnect', () => {
          connBanner.className = 'conn-banner';
          connBanner.textContent = '';
        });
      }

      // â”€â”€ Send Message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      document.getElementById('msg-form').addEventListener('submit', (e) => {
        e.preventDefault();
        sendMessage();
      });

      // Always keep button enabled for mobile compatibility
      sendBtn.disabled = false;

      // Typing indicator
      let typingTimeout = null;
      msgInput.addEventListener('input', () => {
        if (!socket) return;
        socket.emit('user:typing', true);
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
          socket.emit('user:typing', false);
        }, 1500);
      });

      function sendMessage() {
        const text = msgInput.value.trim();
        if (!text || !socket) return;
        socket.emit('chat:message', text);
        socket.emit('user:typing', false);
        msgInput.value = '';
        msgInput.focus();
      }

      // â”€â”€ Render Message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function renderMessage(msg) {
        const isSelf = msg.username === myName;
        const group = document.createElement('div');
        group.className = `msg-group ${isSelf ? 'msg-self' : 'msg-other'}`;

        // Sender name (skip for self)
        const sender = document.createElement('div');
        sender.className = 'msg-sender';
        sender.style.color = msg.color || '#94a3b8';
        sender.textContent = isSelf ? 'You' : msg.username;
        group.appendChild(sender);

        // Bubble
        const bubble = document.createElement('div');
        bubble.className = 'msg-bubble';
        bubble.textContent = msg.text;
        group.appendChild(bubble);

        // Timestamp
        const time = document.createElement('div');
        time.className = 'msg-time';
        time.textContent = formatTime(msg.timestamp);
        group.appendChild(time);

        messagesEl.appendChild(group);
      }

      // â”€â”€ Render User List â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function renderUserList(users) {
        userListEl.innerHTML = '';
        users.forEach(u => {
          const div = document.createElement('div');
          div.className = 'sidebar-user';
          div.innerHTML = `<span class="sidebar-user-dot" style="background:${esc(u.color)}"></span> ${esc(u.username)}`;
          userListEl.appendChild(div);
        });
      }

      // Sidebar toggle
      usersBtn.addEventListener('click', () => {
        userSidebar.classList.toggle('open');
        sidebarOverlay.classList.toggle('open');
      });
      sidebarOverlay.addEventListener('click', () => {
        userSidebar.classList.remove('open');
        sidebarOverlay.classList.remove('open');
      });

      // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function scrollToBottom(instant) {
        requestAnimationFrame(() => {
          messagesEl.scrollTo({
            top: messagesEl.scrollHeight,
            behavior: instant ? 'auto' : 'smooth',
          });
        });
      }

      function formatTime(ts) {
        const d = new Date(ts);
        return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }

      function esc(str) {
        const d = document.createElement('div');
        d.textContent = str;
        return d.innerHTML;
      }
    })();
  </script>
</body>

</html>